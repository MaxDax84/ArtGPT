
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>ArtGPT</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Raleway:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-overlay: rgba(255, 255, 255, 0.85);
      --text-color: #202124;
      --bot-bg: rgba(255, 255, 255, 0.97);
      --user-bg: rgba(26, 115, 232, 0.95);
    }

    body.dark-mode {
      --bg-overlay: rgba(32, 33, 36, 0.85);
      --text-color: #e8eaed;
      --bot-bg: rgba(60, 64, 67, 0.95);
      --user-bg: rgba(138, 180, 248, 0.85);
      background-color: #202124;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Playfair Display', serif;
      background: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-color);
      transition: background 0.6s ease, color 0.6s ease;
    }

    h3, button, input {
      font-family: 'Raleway', sans-serif;
    }

    #chat {
      max-height: 85vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding-bottom: 180px;
    }

    .overlay {
      background-color: var(--bg-overlay);
      backdrop-filter: blur(4px);
      border-radius: 18px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      padding: 25px;
      margin: 20px auto;
      max-width: 900px;
      line-height: 1.7;
      opacity: 0;
      transform: translateY(40px);
      animation: slideFade 0.6s ease-out forwards;
    }

    @keyframes slideFade {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .utente {
      background-color: var(--user-bg);
      color: white;
      font-weight: bold;
      margin-top: 60px;
    }

    .bot {
      background-color: var(--bot-bg);
      border-left: 6px solid #34a853;
    }

    h3 {
      font-size: 1.2em;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding-bottom: 4px;
    }

    h3 span.icon {
      margin-right: 10px;
      font-size: 1.3em;
    }

    .input-barra {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      padding: 20px;
      display: flex;
      justify-content: center;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 100;
    }

    .input-container {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 700px;
      background: #f1f3f4;
      border-radius: 24px;
      padding: 10px 20px;
      border: 1px solid #dadce0;
    }

    .input-container input {
      flex: 1;
      font-size: 16px;
      border: none;
      background: transparent;
      outline: none;
      color: #202124;
    }

    .input-container input::placeholder {
      color: #666;
    }

    .input-container button {
      background: #1a73e8;
      border: none;
      padding: 10px;
      border-radius: 50%;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .input-container button:hover {
      background: #1669c1;
    }

    .input-container button svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    #nuovaChat, #scaricaPDF {
      position: fixed;
      background: white;
      border: 1px solid #dadce0;
      border-radius: 20px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      color: #1a73e8;
      font-weight: bold;
      z-index: 99;
      transition: background 0.3s ease;
    }

    #nuovaChat:hover, #scaricaPDF:hover {
      background: #f1f3f4;
    }

    #nuovaChat {
      bottom: 100px;
      right: 30px;
    }

    #scaricaPDF {
      bottom: 150px;
      right: 30px;
    }

    #themeToggle {
      position: fixed;
      top: 20px;
      right: 30px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      z-index: 101;
    }

    #loader {
      display: none;
      text-align: center;
      margin-top: 30px;
    }

    .dots-typing {
      display: inline-block;
      width: 60px;
      height: 20px;
      position: relative;
    }

    .dots-typing::before, .dots-typing::after, .dots-typing div {
      content: '';
      position: absolute;
      top: 0;
      width: 12px;
      height: 12px;
      background: #1a73e8;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .dots-typing::before { left: 0; animation-delay: -0.32s; }
    .dots-typing div { left: 24px; animation-delay: -0.16s; }
    .dots-typing::after { left: 48px; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }
  </style>
</head>
<body>
  <button id="themeToggle" title="Cambia tema">üåì</button>
  <div id="chat"></div>
  <div id="loader"><div class="dots-typing"><div></div></div></div>

  <div class="input-barra">
    <div class="input-container">
      <input id="domanda" placeholder="Scrivi la tua domanda artistica..." />
      <button onclick="chiedi()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <button id="nuovaChat" onclick="resettaChat()">üîÅ Nuova chat</button>
  <button id="scaricaPDF" onclick="scaricaPDF()">üìÑ Scarica PDF</button>

  <script>
    async function chiedi() {
      const input = document.getElementById("domanda");
      const domanda = input.value.trim();
      if (!domanda) return;

      aggiungiMessaggio("üôã‚Äç‚ôÇÔ∏è", "La tua domanda:", domanda, 'utente');
      input.value = "";
      document.getElementById("loader").style.display = "block";

      try {
        const res = await fetch("/chiedi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ domanda })
        });

        const data = await res.json();
        document.getElementById("loader").style.display = "none";
        aggiungiMessaggio("üé®", "ArtGPT risponde:", data.risposta, 'bot');
      } catch {
        document.getElementById("loader").style.display = "none";
        aggiungiMessaggio("‚ùå", "Errore:", "Errore di rete. Riprova.", '');
      }
    }

    function aggiungiMessaggio(emoji, titolo, contenuto, tipo) {
      const container = document.createElement("div");
      container.className = `overlay ${tipo}`;
      let imgHTML = "";
      if (tipo === "bot") {
        imgHTML = `<img src="https://source.unsplash.com/800x400/?art,painting" style="width:100%; border-radius: 12px; margin-bottom: 16px;">`;
      }
      container.innerHTML = `<h3><span class="icon">${emoji}</span>${titolo}</h3>${imgHTML}${formattaTesto(contenuto)}`;
      document.getElementById("chat").appendChild(container);
      salvaInStorage(emoji, titolo, contenuto, tipo);
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function formattaTesto(testo) {
      const paragrafi = testo.trim().split(/\n{2,}/);
      return paragrafi.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join("");
    }

    function salvaInStorage(emoji, titolo, contenuto, tipo) {
      let logs = JSON.parse(localStorage.getItem("chatGPTlog") || "[]");
      logs.push({ emoji, titolo, contenuto, tipo });
      localStorage.setItem("chatGPTlog", JSON.stringify(logs));
    }

    function caricaStorage() {
      let logs = JSON.parse(localStorage.getItem("chatGPTlog") || "[]");
      for (const msg of logs) {
        aggiungiMessaggio(msg.emoji, msg.titolo, msg.contenuto, msg.tipo);
      }
    }

    async function resettaChat() {
      const res = await fetch("/chiedi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reset: true })
      });

      const data = await res.json();
      document.getElementById("chat").innerHTML = "";
      localStorage.removeItem("chatGPTlog");
      aggiungiMessaggio("üÜï", "", data.risposta, 'bot');
    }

    async function scaricaPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const logs = JSON.parse(localStorage.getItem("chatGPTlog") || "[]");
      let y = 10;
      for (const msg of logs) {
        doc.setFontSize(11);
        doc.setTextColor(msg.tipo === "utente" ? [26, 115, 232] : [52, 168, 83]);
        doc.text(`${msg.emoji} ${msg.titolo}`, 10, y);
        y += 6;
        doc.setTextColor(0, 0, 0);
        const lines = doc.splitTextToSize(msg.contenuto, 180);
        doc.text(lines, 10, y);
        y += lines.length * 6 + 4;
        if (y > 270) { doc.addPage(); y = 10; }
      }
      doc.save("ArtGPT_conversazione.pdf");
    }

    window.onload = caricaStorage;
    document.getElementById("domanda").addEventListener("keypress", function(e) {
      if (e.key === "Enter") chiedi();
    });
    document.getElementById("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });
  </script>
</body>
</html>
